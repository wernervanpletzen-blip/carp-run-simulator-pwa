<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carp Run Alarm Simulator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js is no longer needed if using custom audio -->
    <!-- Link to PWA manifest -->
    <link rel="manifest" href="./manifest.json">
    <style>
        /* Custom styles for aesthetic */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            color: #e5e7eb; /* Light text */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 420px; /* Mobile-first container width */
            padding: 1.5rem;
        }
        .fishing-status {
            min-height: 100px;
        }
        /* Custom button styling for a more tactile feel */
        .btn-start {
            background-color: #0E4C30; /* Darker green */
            transition: transform 0.1s, box-shadow 0.1s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.5);
        }
        .btn-start:hover {
            background-color: #147348; /* Lighter green on hover */
        }
        .btn-start:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.4);
        }
        .btn-reel {
            background-color: #ef4444; /* Red for urgency */
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="selection:bg-gray-700 selection:text-white">

    <div class="container bg-gray-800 rounded-xl shadow-2xl">

        <!-- 1. Logo Placeholder Area -->
        <div class="mb-6 text-center">
            <img src="./assets/logo.png" alt="Your Custom Carp Run Logo" class="mx-auto w-32 h-32 object-contain rounded-full shadow-lg p-2 bg-gray-900" onerror="this.src='https://placehold.co/128x128/1F2937/FFFFFF?text=LOGO'">
        </div>
        
        <!-- 2. Main Button Area -->
        <div class="flex flex-col space-y-4 mb-6">
            <button id="mainButton" 
                    class="btn-start text-white font-extrabold py-4 px-6 rounded-xl text-lg w-full uppercase"
                    onclick="startFishing()">
                Start Fishing
            </button>
        </div>

        <!-- 3. Status and Timer Display -->
        <div id="statusDisplay" class="fishing-status text-center text-xl font-bold p-4 mb-6 rounded-lg bg-gray-900 shadow-inner">
            <p>Ready to cast out?</p>
        </div>

        <!-- 4. Catch Stats Display -->
        <div id="catchStats" class="mt-6 p-4 rounded-lg bg-gray-900 shadow-inner hidden">
            <h3 class="text-xl font-bold mb-3 text-center text-green-400">Catch Log</h3>
            <!-- Stats will be populated here -->
        </div>

    </div>

    <script>
        // Global variables
        const STATUS_DISPLAY = document.getElementById('statusDisplay');
        const MAIN_BUTTON = document.getElementById('mainButton');
        const CATCH_STATS = document.getElementById('catchStats');

        let isFishing = false;
        let biteTimer;
        let reelTimer;
        const REEL_IN_TIME_SECONDS = 15; // User-requested reel-in time
        let biteTime = 0; // Time in ms until the next bite
        
        // --- CUSTOM AUDIO SETUP ---
        // 1. Base64 encoded audio string provided by the user (data:audio/mp3;base64, + raw Base64 data)
        // NOTE: This is still a placeholder string and MUST be replaced with actual audio data.
        const ALARM_BASE64_STRING = "data:audio/mp3;base64,const ALARM_BASE64_STRING = "data:audio/mp3;base64,aW50ZXJfaW5zdGFuY2VfaXNfbXVjaF9tb3JlX2NvbXBsZXhfdGhhbl9qdXN0X3RoZV9kYXRhX3N0cmluZ19oZXJlXw==";"; 
        
        let audioAlarm;
        let alarmInterval;
        let playAttemptCount = 0;
        const MAX_PLAY_ATTEMPTS = 5;

        const initAudio = () => {
            // Create an Audio object from the Base64 string
            if (ALARM_BASE64_STRING.includes("base64")) {
                 audioAlarm = new Audio(ALARM_BASE64_STRING);
                 console.log("Custom Audio Initialized.");
            } else {
                 console.error("Please provide a valid Base64 string for the alarm sound.");
            }
        };

        const playAlarm = () => {
            if (!audioAlarm) return;
            
            playAttemptCount = 0;

            // Function to safely play the audio and handle errors
            const safePlay = () => {
                playAttemptCount++;
                audioAlarm.play()
                    .then(() => {
                        // Playback successful, reset attempts
                        playAttemptCount = 0;
                    })
                    .catch(e => {
                        console.warn(`Audio playback failed (Attempt ${playAttemptCount}):`, e.message);
                        
                        // If it fails repeatedly, stop the alarm loop entirely
                        if (playAttemptCount >= MAX_PLAY_ATTEMPTS) {
                            console.error("Repeated audio failure. Stopping alarm loop.");
                            stopAlarm();
                        }
                    });
            };
            
            // 1. Play once immediately
            safePlay();
            
            // 2. Set an interval to loop the alarm every second for the 15-second reel-in window
            alarmInterval = setInterval(() => {
                // Rewind and play again
                audioAlarm.currentTime = 0; 
                safePlay();
            }, 1000); 

            // Stop the looping after the reel-in time is up
            setTimeout(stopAlarm, REEL_IN_TIME_SECONDS * 1000);
        };

        const stopAlarm = () => {
             if (audioAlarm) {
                audioAlarm.pause();
                audioAlarm.currentTime = 0;
            }
            if (alarmInterval) {
                clearInterval(alarmInterval);
            }
        };

        // --- Game Logic ---

        // NOTE: This is temporarily set for testing the alarm sound. 
        // Generates a random time between 10 seconds (10,000ms) and 30 seconds (30,000ms)
        const generateLongGameBiteTime = () => {
            const minMs = 10 * 1000; // 10 seconds
            const maxMs = 30 * 1000; // 30 seconds
            return Math.floor(Math.random() * (maxMs - minMs + 1)) + minMs;
        };
        
        /**
         * Cleans up timers, audio, and resets the UI to the initial 'Start Fishing' state.
         * @param {string} message - The status message to display after stopping.
         */
        const stopFishing = (message = '<p>Ready to cast out?</p>') => {
            if (biteTimer) clearTimeout(biteTimer);
            if (reelTimer) clearTimeout(reelTimer);
            stopAlarm(); 

            // Clear countdown interval if running (e.g., if user hits stop during reel-in countdown)
            const id = MAIN_BUTTON.getAttribute('data-countdown-id');
            if (id) {
                clearInterval(parseInt(id));
                MAIN_BUTTON.removeAttribute('data-countdown-id');
            }

            isFishing = false;
            
            // Reset button to initial state
            MAIN_BUTTON.textContent = 'Start Fishing';
            MAIN_BUTTON.disabled = false;
            MAIN_BUTTON.classList.remove('bg-red-700', 'hover:bg-red-600', 'btn-reel');
            MAIN_BUTTON.classList.add('btn-start');
            MAIN_BUTTON.onclick = startFishing;
            
            STATUS_DISPLAY.innerHTML = message;
        };

        const startFishing = async () => {
            // TOGGLE LOGIC: If currently fishing, stop the process
            if (isFishing) {
                stopFishing('<p class="text-yellow-400">Fishing stopped. Ready to cast out again.</p>');
                return;
            }

            initAudio(); // Initialize audio object on user interaction

            // --- START FISHING LOGIC ---
            isFishing = true;
            CATCH_STATS.classList.add('hidden');
            CATCH_STATS.innerHTML = `<h3 class="text-xl font-bold mb-3 text-center text-green-400">Catch Log</h3>`;
            
            // Change UI for START/STOP button
            MAIN_BUTTON.textContent = 'Stop Fishing';
            MAIN_BUTTON.disabled = false; // Keep enabled to allow immediate stopping
            MAIN_BUTTON.classList.remove('btn-start');
            MAIN_BUTTON.classList.add('bg-red-700', 'hover:bg-red-600'); // Use red for stop/cancel button
            
            STATUS_DISPLAY.innerHTML = '<p class="text-yellow-400">Casting out... Tight lines!</p>';

            biteTime = generateLongGameBiteTime();
            console.log(`Next bite scheduled in: ${Math.round(biteTime / 1000)} seconds`);

            biteTimer = setTimeout(startBite, biteTime);
        };

        const startBite = () => {
            STATUS_DISPLAY.innerHTML = '<p class="text-red-500">RUN! RUN! RUN!</p>';
            
            // The button action is temporarily overridden to reel in the fish
            MAIN_BUTTON.textContent = `REEL IN! (15s)`;
            MAIN_BUTTON.disabled = false;
            MAIN_BUTTON.classList.remove('bg-red-700', 'hover:bg-red-600');
            MAIN_BUTTON.classList.add('btn-reel');
            MAIN_BUTTON.onclick = () => handleReelIn(true); // User succeeded
            
            playAlarm();
            
            let timeLeft = REEL_IN_TIME_SECONDS;
            
            const countdownInterval = setInterval(() => {
                timeLeft--;
                MAIN_BUTTON.textContent = `REEL IN! (${timeLeft}s)`;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    handleReelIn(false); // User failed to react in time
                }
            }, 1000);

            // Store the interval ID on the button so handleReelIn can stop it
            MAIN_BUTTON.setAttribute('data-countdown-id', countdownInterval);

            // Set the overall reel-in timer to fail after 15 seconds
            reelTimer = setTimeout(() => {
                const id = MAIN_BUTTON.getAttribute('data-countdown-id');
                if (id) {
                    clearInterval(parseInt(id));
                    MAIN_BUTTON.removeAttribute('data-countdown-id');
                }
            }, REEL_IN_TIME_SECONDS * 1000 + 100);
        };

        const generateCarpStats = () => {
            const speciesList = ['Common Carp', 'Mirror Carp', 'Ghost Carp'];
            const species = speciesList[Math.floor(Math.random() * speciesList.length)];

            // Weights for a realistic "long game" catch (5 lbs to 40 lbs)
            const minWeight = 5;
            const maxWeight = 40;
            const weight = (Math.random() * (maxWeight - minWeight) + minWeight).toFixed(2);
            
            // Randomly generate a capture time for realism
            const captureTimeMs = new Date().getTime() - (biteTime - REEL_IN_TIME_SECONDS * 1000);
            const captureTime = new Date(captureTimeMs).toLocaleTimeString();
            
            return { species, weight, captureTime };
        };

        const handleReelIn = (success) => {
            if (!isFishing && success) {
                return; 
            }
            if (!isFishing && !success) {
                // Failure already happened
            }
            
            // 1. Cleanup timers and reset state using the new central function
            // Note: We call this before setting the final message to ensure audio stops instantly
            stopFishing();
            
            let message = '';
            let statsHtml = '';

            if (success) {
                const stats = generateCarpStats();
                message = `Fish Landed! Congratulations on your catch!`;
                
                statsHtml = `
                    <div class="text-center">
                        <p class="text-xl font-extrabold text-green-500">${stats.species}</p>
                        <p class="text-3xl font-black text-yellow-500">${stats.weight} lbs</p>
                        <p class="text-sm text-gray-400">Caught at: ${stats.captureTime}</p>
                    </div>
                `;
            } else {
                message = `Too slow! The fish got away. Keep practicing your reaction time!`;
                statsHtml = `<p class="text-red-400 text-center text-lg">No catch this time. Better luck on the next cast!</p>`;
            }

            STATUS_DISPLAY.innerHTML = `<p>${message}</p>`;
            
            // Update the Catch Log
            CATCH_STATS.classList.remove('hidden');
            const newCatchDiv = document.createElement('div');
            newCatchDiv.classList.add('p-3', 'border-b', 'border-gray-700', 'last:border-b-0');
            newCatchDiv.innerHTML = statsHtml;
            CATCH_STATS.prepend(newCatchDiv); // Prepend to show latest catch at the top
        };

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>
