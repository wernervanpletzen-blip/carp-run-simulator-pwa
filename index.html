<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Carp Run Alarm Simulator</title>

  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="./manifest.webmanifest" />

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background:#000;
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin:0;
      padding:0;
    }
    #startup-overlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.9);
      display:flex;              /* visible by default on first load */
      justify-content:center;
      align-items:center;
      z-index:999;
    }
    .tab-active { background:#3b82f6; color:#fff; }
    .tab-inactive { background:#1f2937; color:#ccc; }
  </style>
</head>

<body class="p-4 text-white flex justify-center min-h-screen">

<div id="app-container" class="max-w-lg w-full bg-gray-900 p-4 rounded-xl border border-gray-700">

  <!-- STARTUP PROFILE SCREEN -->
  <div id="startup-overlay">
    <div class="bg-gray-800 p-6 rounded-xl w-full max-w-sm border border-gray-700 text-center">
      <h1 class="text-2xl font-bold mb-2">Create Profile</h1>
      <p class="text-sm text-gray-300 mb-3">
        Choose a username to start fishing. Your stats will be saved online.
      </p>

      <input id="profile-name-input"
             placeholder="Enter username"
             class="w-full p-2 mb-4 bg-gray-700 border border-gray-600 rounded text-center" />

      <button id="save-profile-btn"
              class="w-full py-2 bg-blue-600 font-bold rounded hover:bg-blue-700 mb-3">
        Save Profile & Start
      </button>

      <button id="continue-btn"
              class="w-full py-2 bg-gray-600 font-bold rounded hover:bg-gray-500 text-sm">
        Continue as Guest (no online stats)
      </button>
    </div>
  </div>

  <!-- HEADER -->
  <div class="flex justify-between items-center mb-4">
    <div>
      <p class="text-xs text-gray-300">Logged in as</p>
      <p id="header-username" class="text-lg font-bold">Guest</p>
    </div>
    <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-xl">ðŸŽ£</div>
  </div>

  <!-- TABS -->
  <div class="flex gap-2 mb-3">
    <button id="tab-fishing" class="flex-1 py-2 rounded tab-active">Fishing</button>
    <button id="tab-profile" class="flex-1 py-2 rounded tab-inactive">Profile</button>
    <button id="tab-leaderboard" class="flex-1 py-2 rounded tab-inactive">Leaderboard</button>
  </div>

  <!-- FISHING SCREEN -->
  <div id="screen-fishing">
    <button id="toggle-fishing-button"
            class="w-full py-2 bg-yellow-500 text-black font-bold rounded mb-4">
      Start Fishing
    </button>

    <div class="bg-gray-700 p-3 rounded text-center mb-4">
      <p id="current-status" class="text-green-400 font-bold">Stopped</p>
      <p id="time-to-bite" class="text-gray-300 text-sm">
        Waiting for a bite...
      </p>
    </div>

    <button id="reel-button"
            class="hidden w-full py-3 bg-green-500 text-black font-bold rounded mb-4">
      Reel In!
    </button>

    <div>
      <h2 class="font-bold mb-2 border-b border-blue-800">Last Catch</h2>
      <div id="log-content" class="bg-gray-800 rounded p-3 border-l-4 border-blue-500">
        No catches yet.
      </div>
    </div>
  </div>

  <!-- PROFILE SCREEN -->
  <div id="screen-profile" class="hidden">
    <h2 class="text-xl font-bold mb-3">Your Stats</h2>
    <p>Biggest carp: <span id="stat-biggest-carp">0</span> kg</p>
    <p>Biggest common: <span id="stat-biggest-common">0</span> kg</p>
    <p>Biggest mirror: <span id="stat-biggest-mirror">0</span> kg</p>
    <p>Total weight: <span id="stat-total-weight">0</span> kg</p>
    <p class="text-xs text-gray-400 mt-3">
      Stats are stored in the cloud for this device. Global leaderboard shows all players.
    </p>
  </div>

  <!-- LEADERBOARD SCREEN -->
  <div id="screen-leaderboard" class="hidden">
    <h2 class="text-xl font-bold mb-1">Leaderboard</h2>
    <p class="text-xs text-gray-400 mb-3">
      Compare your catches with anglers around the world.
    </p>

    <!-- Toggle -->
    <div class="flex gap-2 mb-3">
      <button id="btn-leaderboard-biggest"
              class="flex-1 py-2 rounded text-sm font-bold bg-blue-600 text-white">
        Biggest Carp
      </button>
      <button id="btn-leaderboard-total"
              class="flex-1 py-2 rounded text-sm font-bold bg-gray-700 text-gray-200">
        Total Weight
      </button>
    </div>

    <div id="leaderboard-list" class="space-y-2 text-sm">
      <p class="text-gray-400 text-sm">Loading leaderboard...</p>
    </div>
  </div>

</div>

<!-- Simple service worker registration (optional) -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js').catch(console.error);
  });
}
</script>

<!-- MAIN APP + FIREBASE -->
<script type="module">
  // ==========================
  // Firebase imports
  // ==========================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    serverTimestamp,
    collection,
    getDocs,
    query,
    orderBy,
    limit
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // ==========================
  // Firebase config (yours)
  // ==========================
  const firebaseConfig = {
    apiKey: "AIzaSyASz_xXcEF5pV6CAZR9YfPMUxk_8kS_VTU",
    authDomain: "carp-simulator-app-394af.firebaseapp.com",
    projectId: "carp-simulator-app-394af",
    storageBucket: "carp-simulator-app-394af.firebasestorage.app",
    messagingSenderId: "761509507210",
    appId: "1:761509507210:web:1c5bb0d8af518fab3ebd73"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ==========================
  // DOM references
  // ==========================
  const startupOverlay   = document.getElementById("startup-overlay");
  const nameInput        = document.getElementById("profile-name-input");
  const saveProfileBtn   = document.getElementById("save-profile-btn");
  const continueBtn      = document.getElementById("continue-btn");

  const headerUsername   = document.getElementById("header-username");

  const statBiggestCarp   = document.getElementById("stat-biggest-carp");
  const statBiggestCommon = document.getElementById("stat-biggest-common");
  const statBiggestMirror = document.getElementById("stat-biggest-mirror");
  const statTotalWeight   = document.getElementById("stat-total-weight");

  const toggleFishingButton = document.getElementById("toggle-fishing-button");
  const currentStatusEl     = document.getElementById("current-status");
  const timeToBiteEl        = document.getElementById("time-to-bite");
  const reelButton          = document.getElementById("reel-button");
  const logContentEl        = document.getElementById("log-content");

  const tabFishing     = document.getElementById("tab-fishing");
  const tabProfile     = document.getElementById("tab-profile");
  const tabLeaderboard = document.getElementById("tab-leaderboard");

  const screenFishing     = document.getElementById("screen-fishing");
  const screenProfile     = document.getElementById("screen-profile");
  const screenLeaderboard = document.getElementById("screen-leaderboard");

  const btnLeaderboardBiggest = document.getElementById("btn-leaderboard-biggest");
  const btnLeaderboardTotal   = document.getElementById("btn-leaderboard-total");
  const leaderboardList       = document.getElementById("leaderboard-list");

  // ==========================
  // Profile + ID handling
  // ==========================
  let profile = null;
  let profileId = null;

  function createDefaultProfile(username = "Guest") {
    return {
      username,
      stats: {
        biggestCarpKg: 0,
        biggestCommonKg: 0,
        biggestMirrorKg: 0,
        totalWeightKg: 0
      },
      createdAt: new Date().toISOString()
    };
  }

  function getOrCreateProfileId() {
    try {
      let id = localStorage.getItem("carpProfileId");
      if (!id) {
        id = (self.crypto?.randomUUID?.() || ("id-" + Math.random().toString(36).slice(2)));
        localStorage.setItem("carpProfileId", id);
      }
      return id;
    } catch (e) {
      console.warn("localStorage issue, using in-memory ID only:", e);
      if (!window.__tempProfileId) {
        window.__tempProfileId = "id-" + Math.random().toString(36).slice(2);
      }
      return window.__tempProfileId;
    }
  }

  function hideStartupOverlay() {
    startupOverlay.style.display = "none";
  }

  function showStartupOverlay() {
    startupOverlay.style.display = "flex";
  }

  function updateProfileUI() {
    if (!profile) return;
    headerUsername.textContent = profile.username;

    statBiggestCarp.textContent   = profile.stats.biggestCarpKg.toFixed(1);
    statBiggestCommon.textContent = profile.stats.biggestCommonKg.toFixed(1);
    statBiggestMirror.textContent = profile.stats.biggestMirrorKg.toFixed(1);
    statTotalWeight.textContent   = profile.stats.totalWeightKg.toFixed(1);
  }

  async function loadProfileFromCloud() {
    profileId = getOrCreateProfileId();

    try {
      const ref = doc(db, "players", profileId);
      const snap = await getDoc(ref);

      if (snap.exists()) {
        profile = snap.data();
        if (!profile.stats) {
          profile.stats = createDefaultProfile(profile.username).stats;
        }
        updateProfileUI();
        hideStartupOverlay();
      } else {
        profile = null;
        showStartupOverlay();
      }
    } catch (e) {
      console.error("Failed to load profile from Firestore:", e);
      profile = createDefaultProfile("Guest");
      updateProfileUI();
      showStartupOverlay();
    }
  }

  async function saveProfileToCloud() {
    if (!profileId || !profile) return;

    try {
      const ref = doc(db, "players", profileId);
      await setDoc(ref, {
        ...profile,
        updatedAt: serverTimestamp()
      });
    } catch (e) {
      console.error("Failed to save profile to Firestore:", e);
    }
  }

  // ==========================
  // PROFILE BUTTON HANDLERS
  // ==========================
  saveProfileBtn.addEventListener("click", async () => {
    const name = (nameInput.value || "").trim();
    if (!name) {
      alert("Please enter a username.");
      return;
    }

    if (!profile) {
      profile = createDefaultProfile(name);
    } else {
      profile.username = name;
    }

    updateProfileUI();
    hideStartupOverlay();
    saveProfileToCloud(); // fire & forget
  });

  continueBtn.addEventListener("click", () => {
    if (!profile) {
      profile = createDefaultProfile("Guest");
      updateProfileUI();
    }
    hideStartupOverlay();
  });

  // ==========================
  // FISHING SYSTEM
  // ==========================
  let isFishing = false;
  let countdownValue = 0;
  let biteTimeout = null;
  let catchTimer = null;

  const alarmSound = new Audio("./assets/CarpRunSound001.mp3");
  alarmSound.loop = true;

  function startAlarm(){
    alarmSound.currentTime = 0;
    alarmSound.play().catch(err => console.warn("Alarm play blocked:", err));
  }

  function stopAlarm(){
    alarmSound.pause();
    alarmSound.currentTime = 0;
  }

  function setStatus(text) {
    currentStatusEl.textContent = text;
  }

  function toggleFishing() {
    if (isFishing) {
      stopFishing();
    } else {
      startFishing();
    }
  }

  function startFishing() {
    isFishing = true;
    toggleFishingButton.textContent = "Stop Fishing";
    setStatus("Fishing...");
    timeToBiteEl.textContent = "Waiting for the next run...";

    // Bite between 5 and 60 seconds
    const waitMs = Math.floor(Math.random() * (60000 - 5000 + 1)) + 5000;
    biteTimeout = setTimeout(startBite, waitMs);
  }

  function stopFishing() {
    isFishing = false;
    toggleFishingButton.textContent = "Start Fishing";
    setStatus("Stopped");
    timeToBiteEl.textContent = "Press Start Fishing to cast again.";
    clearTimeout(biteTimeout);
    clearInterval(catchTimer);
    stopAlarm();
    reelButton.classList.add("hidden");
  }

  function startBite() {
    if (!isFishing) return;

    countdownValue = 15;
    setStatus("RUN! RUN! RUN!");
    timeToBiteEl.textContent = "Fish on! Reel in before it gets away!";
    reelButton.textContent = `Reel In! (${countdownValue}s)`;
    reelButton.classList.remove("hidden");
    startAlarm();

    catchTimer = setInterval(() => {
      countdownValue--;
      reelButton.textContent = `Reel In! (${countdownValue}s)`;

      if (countdownValue <= 0) {
        clearInterval(catchTimer);
        reelButton.classList.add("hidden");
        stopAlarm();
        setStatus("Missed run");
        timeToBiteEl.textContent = "Too slow! The fish got away.";
        if (isFishing) {
          setTimeout(startFishing, 3000);
        }
      }
    }, 1000);
  }

  function generateFish() {
    const speciesList = ["Common Carp", "Mirror Carp", "Ghost Carp", "Koi Carp", "Catfish"];
    const species = speciesList[Math.floor(Math.random() * speciesList.length)];
    const weightKg = parseFloat((Math.random() * (55 - 4) + 4).toFixed(1)); // 4â€“55kg
    return {
      species,
      weightKg,
      time: new Date().toLocaleString()
    };
  }

  function applyStats(fish) {
    if (!profile) return; // guest without online saving

    const w = fish.weightKg;
    profile.stats.totalWeightKg += w;

    if (fish.species !== "Catfish" && w > profile.stats.biggestCarpKg) {
      profile.stats.biggestCarpKg = w;
    }
    if (fish.species === "Common Carp" && w > profile.stats.biggestCommonKg) {
      profile.stats.biggestCommonKg = w;
    }
    if (fish.species === "Mirror Carp" && w > profile.stats.biggestMirrorKg) {
      profile.stats.biggestMirrorKg = w;
    }

    updateProfileUI();
    saveProfileToCloud();
  }

  function displayCatch(fish) {
    logContentEl.innerHTML = `
      <p class="text-yellow-400 text-xl font-bold">${fish.weightKg} kg</p>
      <p class="font-bold">${fish.species}</p>
      <p class="text-gray-400 text-sm">${fish.time}</p>
    `;
  }

  function reelIn() {
    clearInterval(catchTimer);
    stopAlarm();
    reelButton.classList.add("hidden");

    const fish = generateFish();
    setStatus("Fish landed!");
    timeToBiteEl.textContent = "Nice one! Preparing to recast...";

    applyStats(fish);
    displayCatch(fish);

    if (isFishing) {
      setTimeout(startFishing, 3000);
    }
  }

  // ==========================
  // LEADERBOARD (Style 3 â€“ Gaming)
  // ==========================
  let currentLeaderboardMode = "biggest"; // "biggest" or "total"

  function setLeaderboardButtons(mode) {
    if (mode === "biggest") {
      btnLeaderboardBiggest.className =
        "flex-1 py-2 rounded text-sm font-bold bg-blue-600 text-white";
      btnLeaderboardTotal.className =
        "flex-1 py-2 rounded text-sm font-bold bg-gray-700 text-gray-200";
    } else {
      btnLeaderboardBiggest.className =
        "flex-1 py-2 rounded text-sm font-bold bg-gray-700 text-gray-200";
      btnLeaderboardTotal.className =
        "flex-1 py-2 rounded text-sm font-bold bg-blue-600 text-white";
    }
  }

  async function loadLeaderboard(mode) {
    currentLeaderboardMode = mode;
    setLeaderboardButtons(mode);
    leaderboardList.innerHTML = `<p class="text-gray-400 text-sm">Loading leaderboard...</p>`;

    try {
      const playersRef = collection(db, "players");
      const field = mode === "total" ? "stats.totalWeightKg" : "stats.biggestCarpKg";
      const q = query(playersRef, orderBy(field, "desc"), limit(10));
      const snap = await getDocs(q);

      if (snap.empty) {
        leaderboardList.innerHTML = `<p class="text-gray-400 text-sm">No data yet. Be the first to land a carp!</p>`;
        return;
      }

      const players = [];
      snap.forEach(docSnap => {
        const d = docSnap.data() || {};
        const s = d.stats || {};
        players.push({
          username: d.username || "Unknown angler",
          biggestCarpKg: Number(s.biggestCarpKg || 0),
          totalWeightKg: Number(s.totalWeightKg || 0)
        });
      });

      let html = "";
      players.forEach((p, index) => {
        let rankIcon = `${index + 1}.`;
        if (index === 0) rankIcon = "ðŸ¥‡";
        else if (index === 1) rankIcon = "ðŸ¥ˆ";
        else if (index === 2) rankIcon = "ðŸ¥‰";

        const statValue =
          mode === "total"
            ? `${p.totalWeightKg.toFixed(1)} kg`
            : `${p.biggestCarpKg.toFixed(1)} kg`;

        const statLabel =
          mode === "total" ? "Total Weight" : "Biggest Carp";

        html += `
          <div class="flex items-center justify-between bg-gray-800 rounded-lg px-3 py-2 border border-gray-700">
            <div class="flex items-center gap-3">
              <div class="text-xl">${rankIcon}</div>
              <div>
                <p class="font-bold text-sm">${p.username}</p>
                <p class="text-xs text-gray-400">${statLabel}</p>
              </div>
            </div>
            <div class="font-bold text-sm text-yellow-300">
              ${statValue}
            </div>
          </div>
        `;
      });

      leaderboardList.innerHTML = html;
    } catch (e) {
      console.error("Error loading leaderboard:", e);
      leaderboardList.innerHTML =
        `<p class="text-red-400 text-sm">Could not load leaderboard right now.</p>`;
    }
  }

  btnLeaderboardBiggest.addEventListener("click", () => loadLeaderboard("biggest"));
  btnLeaderboardTotal.addEventListener("click", () => loadLeaderboard("total"));

  // ==========================
  // TABS
  // ==========================
  function showTab(tab){
    screenFishing.classList.add("hidden");
    screenProfile.classList.add("hidden");
    screenLeaderboard.classList.add("hidden");

    tabFishing.classList.remove("tab-active");
    tabProfile.classList.remove("tab-active");
    tabLeaderboard.classList.remove("tab-active");

    tabFishing.classList.add("tab-inactive");
    tabProfile.classList.add("tab-inactive");
    tabLeaderboard.classList.add("tab-inactive");

    if (tab === "fishing") {
      screenFishing.classList.remove("hidden");
      tabFishing.classList.add("tab-active");
    } else if (tab === "profile") {
      screenProfile.classList.remove("hidden");
      tabProfile.classList.add("tab-active");
    } else if (tab === "leaderboard") {
      screenLeaderboard.classList.remove("hidden");
      tabLeaderboard.classList.add("tab-active");
      // load current leaderboard mode when switching to this tab
      loadLeaderboard(currentLeaderboardMode);
    }
  }

  tabFishing.addEventListener("click", () => showTab("fishing"));
  tabProfile.addEventListener("click", () => showTab("profile"));
  tabLeaderboard.addEventListener("click", () => showTab("leaderboard"));

  // ==========================
  // BUTTON EVENTS
  // ==========================
  toggleFishingButton.addEventListener("click", toggleFishing);
  reelButton.addEventListener("click", reelIn);

  // ==========================
  // INIT
  // ==========================
  window.addEventListener("load", () => {
    loadProfileFromCloud();
    // Fishing tab is default
    showTab("fishing");
  });
</script>

</body>
</html>
