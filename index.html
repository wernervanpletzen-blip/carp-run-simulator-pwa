<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carp Run Simulator</title>

    <meta name="theme-color" content="#111827" />
    <link rel="manifest" href="manifest.json" />

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: black;
            color: white;
            margin: 0;
            padding: 0;
        }
        #app-container {
            max-width: 600px;
            margin: auto;
            padding: 20px;
        }
        .alarm-flash {
            animation: flash 0.25s infinite alternate;
            background-color: #ff3333 !important;
        }
        @keyframes flash {
            from { box-shadow: 0 0 10px red; }
            to   { box-shadow: 0 0 30px red; }
        }
        .fish-image {
            width: 100%;
            border-radius: 1rem;
            margin-top: 10px;
        }
        .logo {
            width: 200px;
            display: block;
            margin: 0 auto 20px auto;
        }
    </style>
</head>

<body>
<div id="app-container">

    <img src="assets/logo.png" class="logo" />

    <!-- CREATE PROFILE SCREEN -->
    <div id="profile-screen" class="text-center mt-10">
        <h1 class="text-3xl font-bold mb-4">Create Profile</h1>
        <input id="profileNameInput"
               class="w-full p-3 rounded text-black mb-4"
               placeholder="Enter your name" />
        <button onclick="saveProfile()"
                class="bg-blue-500 px-6 py-3 rounded-lg font-bold hover:bg-blue-600">
            Save Profile
        </button>
    </div>

    <!-- MAIN GAME SCREEN -->
    <div id="game-screen" class="hidden">

        <img src="assets/logo.png" class="logo" />

        <h1 class="text-center text-2xl font-bold mt-2">Carp Run Simulator</h1>

        <div class="text-center mt-4">
            <button id="toggle-fish-btn"
                    onclick="toggleFishing()"
                    class="bg-yellow-500 text-black px-6 py-3 rounded-lg font-bold hover:bg-yellow-400">
                Start Fishing
            </button>
        </div>

        <p id="statusText" class="mt-4 text-center text-lg"></p>
        <p id="timeToBite" class="text-center text-gray-400 text-sm"></p>

        <button id="reelButton"
                onclick="reelIn()"
                class="hidden w-full bg-green-500 text-black font-bold text-xl px-6 py-4 rounded-lg mt-6">
            Reel In!
        </button>

        <div id="catchDisplay" class="mt-6 text-center"></div>

        <div class="text-center mt-8">
            <button onclick="showLeaderboard()"
                    class="bg-purple-600 px-6 py-3 rounded-lg font-bold hover:bg-purple-700">
                View Leaderboard
            </button>
        </div>
    </div>

    <!-- LEADERBOARD -->
    <div id="leaderboard-screen" class="hidden">
        <img src="assets/logo.png" class="logo" />
        <h2 class="text-3xl font-bold text-center mb-4">World Leaderboard</h2>
        <div id="leaderboardList" class="p-4 bg-gray-800 rounded-lg"></div>
        <div class="text-center mt-6">
            <button onclick="closeLeaderboard()"
                    class="bg-blue-500 px-6 py-3 rounded-lg font-bold hover:bg-blue-600">
                Back
            </button>
        </div>
    </div>

</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyASz_xXcEF5pV6CAZR9YfPMUxk_8kS_VTU",
  authDomain: "carp-simulator-app-394af.firebaseapp.com",
  projectId: "carp-simulator-app-394af",
  storageBucket: "carp-simulator-app-394af.firebasestorage.app",
  messagingSenderId: "761509507210",
  appId: "1:761509507210:web:1c5bb0d8af518fab3ebd73"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser = null;
let profileRef = null;

auth.signInAnonymously().catch(console.error);

auth.onAuthStateChanged(user => {
    if (!user) return;
    currentUser = user;
    profileRef = db.collection("players").doc(user.uid);
    loadProfile();
});

/* Load profile */
async function loadProfile() {
    const doc = await profileRef.get();
    if (doc.exists) {
        document.getElementById("profile-screen").classList.add("hidden");
        document.getElementById("game-screen").classList.remove("hidden");
        updateUI();
    }
}

/* Save profile */
async function saveProfile() {
    const name = document.getElementById("profileNameInput").value.trim();
    if (!name) return;

    await profileRef.set({
        name: name,
        totalWeightKg: 0,
        biggestCarpKg: 0,
        biggestCommonKg: 0,
        biggestMirrorKg: 0,
        biggestFullyScaledKg: 0,
        biggestGhostKg: 0,
        biggestKoiKg: 0,
        catfishCount: 0
    });

    document.getElementById("profile-screen").classList.add("hidden");
    document.getElementById("game-screen").classList.remove("hidden");
}

/* LEADERBOARD */
async function showLeaderboard() {
    document.getElementById("game-screen").classList.add("hidden");
    document.getElementById("leaderboard-screen").classList.remove("hidden");

    const list = document.getElementById("leaderboardList");
    list.innerHTML = "Loading...";

    const snap = await db.collection("players")
        .orderBy("biggestCarpKg", "desc")
        .limit(20)
        .get();

    list.innerHTML = "";
    snap.forEach(doc => {
        const d = doc.data();
        list.innerHTML += `
            <div class="p-3 border-b border-gray-600">
                <span class="font-bold">${d.name}</span> â€”
                PB: ${d.biggestCarpKg || 0} kg
            </div>
        `;
    });
}

function closeLeaderboard() {
    document.getElementById("leaderboard-screen").classList.add("hidden");
    document.getElementById("game-screen").classList.remove("hidden");
}

/* GAME LOGIC */
let isFishing = false;
let biteTimeout = null;
let countdownTimer = null;
let countdownValue = 0;

function toggleFishing() {
    if (isFishing) {
        stopFishing();
    } else {
        startFishing();
    }
}

/* Start fishing */
function startFishing() {
    isFishing = true;
    document.getElementById("toggle-fish-btn").textContent = "Stop Fishing";
    document.getElementById("statusText").textContent = "Lines are in! Waiting...";
    document.getElementById("catchDisplay").innerHTML = "";

    const min = 20000;      // 20 seconds
    const max = 1800000;    // 30 minutes
    const biteTime = Math.floor(Math.random() * (max - min)) + min;

    biteTimeout = setTimeout(startBite, biteTime);

    document.getElementById("timeToBite").textContent =
        "A carp could pick up the bait any moment...";
}

/* Stop fishing */
function stopFishing() {
    isFishing = false;
    clearTimeout(biteTimeout);
    clearInterval(countdownTimer);

    document.getElementById("toggle-fish-btn").textContent = "Start Fishing";
    document.getElementById("statusText").textContent = "Fishing stopped.";
    document.getElementById("reelButton").classList.add("hidden");
}

/* Bite occurs */
function startBite() {
    if (!isFishing) return;

    navigator.vibrate?.(300);

    document.body.classList.add("alarm-flash");

    countdownValue = 15;
    document.getElementById("reelButton").classList.remove("hidden");
    document.getElementById("reelButton").textContent = `Reel In! (${countdownValue}s)`;

    countdownTimer = setInterval(() => {
        countdownValue--;
        document.getElementById("reelButton").textContent = `Reel In! (${countdownValue}s)`;

        if (countdownValue <= 0) {
            clearInterval(countdownTimer);
            document.body.classList.remove("alarm-flash");
            document.getElementById("reelButton").classList.add("hidden");
            stopFishing();
            document.getElementById("statusText").textContent = "âŒ The fish got away!";
        }
    }, 1000);
}

/* Reel in */
async function reelIn() {
    clearInterval(countdownTimer);
    document.body.classList.remove("alarm-flash");
    document.getElementById("reelButton").classList.add("hidden");

    const carp = generateCarpDetails();

    document.getElementById("statusText").textContent =
        `ðŸŽ£ You caught a ${carp.weightKg} kg (${carp.weightLbs} lb) ${carp.species}!`;

    document.getElementById("catchDisplay").innerHTML = `
        <img src="${carp.image}" class="fish-image" />
    `;

    await updateStats(carp);

    stopFishing();
}

/* Update Firestore stats */
async function updateStats(carp) {
    const doc = await profileRef.get();
    if (!doc.exists) return;

    const p = doc.data();

    const totalWeight = (p.totalWeightKg || 0) + parseFloat(carp.weightKg);

    const updated = {
        totalWeightKg: totalWeight,
        biggestCarpKg: Math.max(p.biggestCarpKg || 0, carp.weightKg)
    };

    if (carp.species === "Common Carp")
        updated.biggestCommonKg = Math.max(p.biggestCommonKg || 0, carp.weightKg);

    if (carp.species === "Mirror Carp")
        updated.biggestMirrorKg = Math.max(p.biggestMirrorKg || 0, carp.weightKg);

    if (carp.species === "Fully Scaled Carp")
        updated.biggestFullyScaledKg = Math.max(p.biggestFullyScaledKg || 0, carp.weightKg);

    if (carp.species === "Ghost Carp")
        updated.biggestGhostKg = Math.max(p.biggestGhostKg || 0, carp.weightKg);

    if (carp.species === "Koi Carp")
        updated.biggestKoiKg = Math.max(p.biggestKoiKg || 0, carp.weightKg);

    if (carp.species === "Catfish")
        updated.catfishCount = (p.catfishCount || 0) + 1;

    await profileRef.update(updated);
}

/* Get fish image */
function getFishImage(species, kg) {
    if (species === "Catfish") return "fish/catfish.png";

    if (kg < 17) return `fish/${species}-small.png`;
    if (kg < 40) return `fish/${species}-big.png`;

    return `fish/${species}-monster.png`;
}

/* Weighted random */
function weightedRandom(weights) {
    const total = Object.values(weights).reduce((a, b) => a + b, 0);
    let r = Math.random() * total;
    for (const [key, value] of Object.entries(weights)) {
        if (r < value) return key;
        r -= value;
    }
}

/* Generate carp details */
function generateCarpDetails() {
    const speciesWeights = {
        "Common Carp": 25,
        "Mirror Carp": 20,
        "Fully Scaled Carp": 10,
        "Ghost Carp": 8,
        "Koi Carp": 5,
        "Catfish": 32
    };

    const species = weightedRandom(speciesWeights);

    let kg;

    const roll = Math.random();

    if (species === "Catfish") {
        kg = Math.random() * (25 - 5) + 5;
    } else {
        if (roll < 0.55) kg = Math.random() * (17 - 4) + 4;
        else if (roll < 0.85) kg = Math.random() * (25 - 17) + 17;
        else if (roll < 0.97) kg = Math.random() * (40 - 25) + 25;
        else kg = Math.random() * (55 - 40) + 40;
    }

    const lbs = kg * 2.20462;

    return {
        species,
        weightKg: kg.toFixed(1),
        weightLbs: lbs.toFixed(1),
        image: getFishImage(species, kg)
    };
}
</script>

</body>
</html>
