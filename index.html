<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carp Run Alarm Simulator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for sound generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Link to PWA manifest -->
    <link rel="manifest" href="./manifest.json">
    <style>
        /* Custom styles for aesthetic */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            color: #e5e7eb; /* Light text */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 420px; /* Mobile-first container width */
            padding: 1.5rem;
        }
        .fishing-status {
            min-height: 100px;
        }
        /* Custom button styling for a more tactile feel */
        .btn-start {
            background-color: #0E4C30; /* Darker green */
            transition: transform 0.1s, box-shadow 0.1s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.5);
        }
        .btn-start:hover {
            background-color: #147348; /* Lighter green on hover */
        }
        .btn-start:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.4);
        }
        .btn-reel {
            background-color: #ef4444; /* Red for urgency */
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="selection:bg-gray-700 selection:text-white">

    <div class="container bg-gray-800 rounded-xl shadow-2xl">

        <!-- 1. Logo Placeholder Area (Made Bigger: w-48 h-48) -->
        <div class="mb-6 text-center">
            <!-- Ensure your logo.png is in the 'assets' folder! -->
            <img src="./assets/logo.png" alt="Your Custom Carp Run Logo" class="mx-auto w-48 h-48 object-contain rounded-full shadow-lg p-2 bg-gray-900" onerror="this.src='https://placehold.co/192x192/1F2937/FFFFFF?text=LOGO'">
        </div>
        
        <!-- 2. Main Button Area (Moved up) -->
        <div class="flex flex-col space-y-4 mb-6">
            <button id="mainButton" 
                    class="btn-start text-white font-extrabold py-4 px-6 rounded-xl text-lg w-full uppercase"
                    onclick="startFishing()">
                Start Fishing
            </button>
        </div>

        <!-- 3. Status and Timer Display (Moved down) -->
        <div id="statusDisplay" class="fishing-status text-center text-xl font-bold p-4 mb-6 rounded-lg bg-gray-900 shadow-inner">
            <p>Ready to cast out?</p>
        </div>

        <!-- 4. Catch Stats Display -->
        <div id="catchStats" class="mt-6 p-4 rounded-lg bg-gray-900 shadow-inner hidden">
            <h3 class="text-xl font-bold mb-3 text-center text-green-400">Catch Log</h3>
            <!-- Stats will be populated here -->
        </div>

    </div>

    <script>
        // Global variables
        const STATUS_DISPLAY = document.getElementById('statusDisplay');
        const MAIN_BUTTON = document.getElementById('mainButton');
        const CATCH_STATS = document.getElementById('catchStats');

        let isFishing = false;
        let biteTimer;
        let reelTimer;
        const REEL_IN_TIME_SECONDS = 15; // User-requested reel-in time
        let biteTime = 0; // Time in ms until the next bite

        // --- Sound Generation ---
        let alarmSynth;
        const initAudio = async () => {
            // Check if audio context is running (required for Tone.js)
            if (Tone.context.state !== 'running') {
                await Tone.start();
            }
            // Create a simple alarm synth (e.g., a simple beep)
            alarmSynth = new Tone.Synth().toDestination();
            console.log("Audio Context Initialized.");
        };

        const playAlarm = () => {
            if (alarmSynth) {
                // Play C4 for 0.2 seconds
                alarmSynth.triggerAttackRelease("C4", "8n");
                // Repeat for an urgent alarm sound
                Tone.Transport.scheduleRepeat((time) => {
                    alarmSynth.triggerAttackRelease("C5", "16n", time, 0.5);
                    alarmSynth.triggerAttackRelease("C4", "16n", time + 0.1, 0.5);
                }, "4n", 0, REEL_IN_TIME_SECONDS);
                Tone.Transport.start();
            }
        };

        const stopAlarm = () => {
            if (alarmSynth) {
                Tone.Transport.stop();
                Tone.Transport.cancel();
            }
        };

        // --- Game Logic ---

        // Generates a random time between 1 minute (60,000ms) and 2 hours (7,200,000ms)
        const generateLongGameBiteTime = () => {
            const minMs = 60 * 1000; // 1 minute
            const maxMs = 120 * 60 * 1000; // 2 hours
            return Math.floor(Math.random() * (maxMs - minMs + 1)) + minMs;
        };

        const startFishing = async () => {
            if (isFishing) return;

            await initAudio(); // Initialize audio on user interaction

            isFishing = true;
            CATCH_STATS.classList.add('hidden');
            CATCH_STATS.innerHTML = `<h3 class="text-xl font-bold mb-3 text-center text-green-400">Catch Log</h3>`;
            
            MAIN_BUTTON.textContent = 'Bait set. Waiting for a run...';
            MAIN_BUTTON.disabled = true;
            MAIN_BUTTON.classList.remove('btn-start');
            MAIN_BUTTON.classList.add('bg-gray-700', 'cursor-not-allowed');
            STATUS_DISPLAY.innerHTML = '<p class="text-yellow-400">Casting out... Tight lines!</p>';

            biteTime = generateLongGameBiteTime();
            console.log(`Next bite scheduled in: ${Math.round(biteTime / 60000)} minutes`);

            biteTimer = setTimeout(startBite, biteTime);
        };

        const startBite = () => {
            STATUS_DISPLAY.innerHTML = '<p class="text-red-500">RUN! RUN! RUN!</p>';
            
            MAIN_BUTTON.textContent = `REEL IN! (15s)`;
            MAIN_BUTTON.disabled = false;
            MAIN_BUTTON.classList.remove('bg-gray-700', 'cursor-not-allowed');
            MAIN_BUTTON.classList.add('btn-reel');
            MAIN_BUTTON.onclick = () => handleReelIn(true); // User succeeded
            
            playAlarm();
            
            let timeLeft = REEL_IN_TIME_SECONDS;
            
            const countdownInterval = setInterval(() => {
                timeLeft--;
                MAIN_BUTTON.textContent = `REEL IN! (${timeLeft}s)`;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    handleReelIn(false); // User failed to react in time
                }
            }, 1000);

            // Set the overall reel-in timer to fail after 15 seconds
            reelTimer = setTimeout(() => {
                clearInterval(countdownInterval);
                // If handleReelIn wasn't called by a successful click, it will be called by the interval at 0s. 
                // We keep this here as a safety fallback, but the interval handles the logic.
            }, REEL_IN_TIME_SECONDS * 1000 + 100);
        };

        const generateCarpStats = () => {
            const speciesList = ['Common Carp', 'Mirror Carp', 'Ghost Carp'];
            const species = speciesList[Math.floor(Math.random() * speciesList.length)];

            // Weights for a realistic "long game" catch (5 lbs to 40 lbs)
            const minWeight = 5;
            const maxWeight = 40;
            const weight = (Math.random() * (maxWeight - minWeight) + minWeight).toFixed(2);
            
            // Randomly generate a capture time for realism
            const captureTimeMs = new Date().getTime() - (biteTime - REEL_IN_TIME_SECONDS * 1000);
            const captureTime = new Date(captureTimeMs).toLocaleTimeString();
            
            return { species, weight, captureTime };
        };

        const handleReelIn = (success) => {
            if (!isFishing) return;
            isFishing = false;

            stopAlarm();
            clearTimeout(reelTimer);
            
            MAIN_BUTTON.onclick = startFishing; // Reset button action
            MAIN_BUTTON.classList.remove('btn-reel');
            MAIN_BUTTON.classList.add('btn-start');
            
            let message = '';
            let statsHtml = '';

            if (success) {
                const stats = generateCarpStats();
                message = `Fish Landed! Congratulations on your catch!`;
                
                statsHtml = `
                    <div class="text-center">
                        <p class="text-xl font-extrabold text-green-500">${stats.species}</p>
                        <p class="text-3xl font-black text-yellow-500">${stats.weight} lbs</p>
                        <p class="text-sm text-gray-400">Caught at: ${stats.captureTime}</p>
                    </div>
                `;
            } else {
                message = `Too slow! The fish got away. Keep practicing your reaction time!`;
                statsHtml = `<p class="text-red-400 text-center text-lg">No catch this time. Better luck on the next cast!</p>`;
            }

            STATUS_DISPLAY.innerHTML = `<p>${message}</p>`;
            MAIN_BUTTON.textContent = 'Start Fishing';
            MAIN_BUTTON.disabled = false;
            
            // Update the Catch Log
            CATCH_STATS.classList.remove('hidden');
            const newCatchDiv = document.createElement('div');
            newCatchDiv.classList.add('p-3', 'border-b', 'border-gray-700', 'last:border-b-0');
            newCatchDiv.innerHTML = statsHtml;
            CATCH_STATS.appendChild(newCatchDiv);
        };

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>
