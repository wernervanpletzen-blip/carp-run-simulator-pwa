<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Carp Run Alarm Simulator</title>

  <!-- âœ… PWA Meta -->
  <meta name="theme-color" content="#111827" />
  <meta name="description" content="Simulate real carp fishing runs with authentic Delkim alarm sounds and random bite timing." />

  <!-- âœ… Correct relative path for GitHub Pages -->
  <link rel="manifest" href="./manifest.webmanifest" />

  <!-- âœ… App Icons for iOS & Android -->
  <link rel="apple-touch-icon" href="./assets/icon-192.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="./assets/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="./assets/icon-512.png" />

  <!-- âœ… Apple compatibility -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Carp Run" />

  <!-- âœ… Tailwind + Fonts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet" />
</head>

<body class="bg-black text-white font-[Inter] flex justify-center items-center min-h-screen p-4">
  <div id="app-container" class="bg-gray-900 border-2 border-gray-700 rounded-xl p-6 w-full max-w-lg text-center">
    <img src="./assets/logo.png" alt="Carp Run Logo" class="mx-auto w-32 h-32 object-contain mb-6" />

    <button id="toggle-fishing-button"
      class="px-6 py-2 text-lg font-bold rounded-lg bg-yellow-500 text-gray-900 hover:bg-yellow-400 transition mb-6"
      onclick="toggleFishing()">Start Fishing</button>

    <div id="status-display" class="bg-gray-700 p-4 mb-6 rounded-lg">
      <p id="current-status" class="text-lg font-bold text-green-400">Stopped</p>
      <p id="time-to-bite" class="text-sm mt-1 text-gray-300">Ready to cast your lines! The wait could be anywhere from 2 to 30 minutes.</p>
    </div>

    <button id="reel-button"
      class="hidden w-full px-6 py-4 text-2xl font-bold rounded-xl bg-green-500 text-gray-900 hover:bg-green-400 transition mb-6"
      onclick="reelIn()">Reel In! (15s left)</button>

    <div id="last-catch-log" class="text-left">
      <h2 class="text-xl font-bold mb-2 uppercase border-b border-blue-800 pb-1">Last Catch Statistics</h2>
      <div id="log-content" class="bg-gray-800 rounded-lg p-4 border-l-4 border-blue-500">
        <p class="text-gray-300">No successful catches yet. Tight lines!</p>
      </div>
    </div>
  </div>

  <!-- Install App Button -->
  <button id="install-btn"
    class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 bg-blue-500 text-white font-bold px-5 py-3 rounded-lg shadow-lg hover:bg-blue-600 z-50">
    Install Carp Run App
  </button>

  <script type="module">
    // --- Service Worker Registration ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => console.log('Service Worker registered:', reg.scope))
          .catch(err => console.log('Service Worker failed:', err));
      });
    }

    // --- Global State ---
    let status = 'STOPPED', isFishing = false, catchTimer = null, biteTimeout = null, countdownValue = 0;

    // --- Wake Lock ---
    let wakeLock = null;
    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          console.log('Wake Lock active');
        } catch (err) { console.error('Wake Lock error:', err); }
      }
    }
    async function releaseWakeLock() {
      if (wakeLock) { await wakeLock.release(); wakeLock = null; }
    }

    // --- Audio Setup ---
    const alarmSound = new Audio('./assets/CarpRunSound001.mp3');
    alarmSound.loop = true;
    function startAlarmSound() { alarmSound.currentTime = 0; alarmSound.play().catch(console.warn); }
    function stopAlarmSound() { alarmSound.pause(); alarmSound.currentTime = 0; }

    // --- Elements ---
    const statusEl = document.getElementById('current-status');
    const timeEl = document.getElementById('time-to-bite');
    const reelBtn = document.getElementById('reel-button');
    const logEl = document.getElementById('log-content');
    const toggleBtn = document.getElementById('toggle-fishing-button');
    const appContainer = document.getElementById('app-container');
    const installBtn = document.getElementById('install-btn');

    // --- Simulation ---
    function getNextBiteTime() {
      return Math.floor(Math.random() * (1800000 - 120000 + 1)) + 120000; // 2â€“30 mins
    }

    function updateStatus(newStatus, msg) {
      status = newStatus;
      statusEl.textContent = `STATUS: ${newStatus}`;
      appContainer.classList.remove('alarm-flash');
      reelBtn.classList.add('hidden');
      if (status !== 'ALARM') timeEl.textContent = msg;
      if (status === 'ALARM') {
        appContainer.classList.add('alarm-flash');
        reelBtn.classList.remove('hidden');
        reelBtn.textContent = `Reel In! (${countdownValue}s left)`;
      }
    }

    function startFishingCycle() {
      requestWakeLock();
      isFishing = true;
      toggleBtn.textContent = "Stop Fishing";
      toggleBtn.classList.replace('bg-yellow-500', 'bg-red-600');
      clearTimeout(biteTimeout);
      biteTimeout = setTimeout(startBite, getNextBiteTime());
      updateStatus('FISHING', 'Bait set. Waiting for the sound of a big run...');
    }

    function stopFishing() {
      releaseWakeLock();
      isFishing = false;
      toggleBtn.textContent = "Start Fishing";
      toggleBtn.classList.replace('bg-red-600', 'bg-yellow-500');
      clearTimeout(biteTimeout); clearInterval(catchTimer);
      stopAlarmSound();
      updateStatus('STOPPED', 'Fishing stopped. Press Start Fishing to cast again.');
    }

    window.toggleFishing = () => isFishing ? stopFishing() : startFishingCycle();

    function startBite() {
      if (!isFishing) return;
      countdownValue = 15;
      updateStatus('ALARM', '*** FISH ON! REEL IN QUICK! ***');
      startAlarmSound();
      catchTimer = setInterval(() => {
        countdownValue--;
        reelBtn.textContent = `REEL IN! (${countdownValue}S LEFT)`;
        if (countdownValue <= 0) {
          clearInterval(catchTimer); stopAlarmSound();
          updateStatus('LOST', 'âŒ TOO SLOW! The line snapped and the fish got away!');
          if (isFishing) setTimeout(startFishingCycle, 5000);
        }
      }, 1000);
    }

    window.reelIn = () => {
      if (status !== 'ALARM') return;
      clearInterval(catchTimer); stopAlarmSound();
      updateStatus('CAUGHT', 'ðŸŽ‰ REELING SUCCESSFUL!');
      displayCatch(generateCatch());
      if (isFishing) setTimeout(startFishingCycle, 5000);
    };

    function generateCatch() {
      const species = ['Common Carp', 'Mirror Carp', 'Ghost Carp', 'Leather Carp', 'Fully Scaled Carp'];
      const s = species[Math.floor(Math.random() * species.length)];
      let w = Math.random() < 0.5 ? Math.random() * 20 + 15 :
               Math.random() < 0.85 ? Math.random() * 15 + 35 :
               Math.random() * 20 + 50;
      return { species: s, weight: w.toFixed(1), time: new Date().toLocaleString() };
    }

    function displayCatch(c) {
      logEl.innerHTML = `
        <div class="space-y-2">
          <p class="font-extrabold text-2xl text-yellow-400">${c.weight} LBS</p>
          <p class="font-bold text-lg">${c.species.toUpperCase()}</p>
          <p class="text-sm text-gray-400">Time: ${c.time}</p>
          <p class="text-xs text-gray-500 mt-2">Ready to cast again in 5 seconds...</p>
        </div>`;
    }

    // --- Install Prompt ---
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault(); deferredPrompt = e;
      installBtn.classList.remove('hidden');
    });
    installBtn.addEventListener('click', () => {
      installBtn.classList.add('hidden');
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(() => deferredPrompt = null);
    });

    window.onload = () => updateStatus('STOPPED', 'Ready to cast your lines! The wait could be anywhere from 2 to 30 minutes.');
  </script>
</body>
</html>
