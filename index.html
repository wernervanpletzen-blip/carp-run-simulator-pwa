<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Carp Run Simulator</title>

<meta name="theme-color" content="#111827" />
<link rel="manifest" href="./manifest.webmanifest" />
<script src="https://cdn.tailwindcss.com"></script>

<style>
  body { background:#000; font-family:Inter,sans-serif; margin:0; }
  #startup-overlay { position:fixed; inset:0; background:#000d; display:flex; justify-content:center; align-items:center; z-index:9999; }
  .tab-active { background:#3b82f6; color:#fff; }
  .tab-inactive { background:#1f2937; color:#ccc; }
  #pb-popup { backdrop-filter:blur(3px); }
  @keyframes pbFade {
    0%{opacity:0;transform:scale(.7)}
    10%{opacity:1;transform:scale(1)}
    90%{opacity:1;transform:scale(1)}
    100%{opacity:0;transform:scale(.7)}
  }
  .animate-pb-popup { animation:pbFade 2.8s ease forwards; }
</style>
</head>

<body class="p-4 text-white flex justify-center min-h-screen">

<!-- PB POPUP -->
<div id="pb-popup" class="fixed inset-0 hidden items-center justify-center z-[9999]">
  <div class="bg-black/80 px-6 py-4 rounded-xl text-center border border-yellow-400 shadow-lg animate-pb-popup">
    <p id="pb-text" class="text-yellow-300 text-2xl font-extrabold drop-shadow-lg"></p>
  </div>
</div>

<div id="app-container" class="max-w-lg w-full bg-gray-900 p-4 rounded-xl border border-gray-700">

<!-- STARTUP SCREEN -->
<div id="startup-overlay">
  <div class="bg-gray-800 p-6 rounded-xl w-full max-w-sm border border-gray-700 text-center">
    <img src="./assets/logo.png" class="w-28 h-28 mx-auto mb-4 rounded-lg border border-gray-600" />
    <h1 class="text-2xl font-bold mb-2">Create Profile</h1>
    <p class="text-sm text-gray-300 mb-3">Choose a username to begin.</p>
    <input id="profile-name-input" placeholder="Enter username"
           class="w-full p-2 mb-4 bg-gray-700 border border-gray-600 rounded text-center" />
    <button id="save-profile-btn" class="w-full py-2 bg-blue-600 font-bold rounded mb-3">
      Save Profile & Start
    </button>
    <button id="continue-btn" class="w-full py-2 bg-gray-600 font-bold rounded text-sm">
      Continue as Guest
    </button>
  </div>
</div>

<!-- HEADER -->
<div class="flex flex-col items-center text-center mb-4 mt-2">
  <img src="./assets/logo.png" class="w-[110px] h-[110px] rounded-xl mb-2 border border-gray-600" />
  <div>
    <p class="text-xs text-gray-300">Logged in as</p>
    <p id="header-username" class="text-lg font-bold">Loading…</p>
  </div>
</div>

<!-- TABS -->
<div class="flex gap-2 mb-3">
  <button id="tab-fishing" class="flex-1 py-2 rounded tab-active">Fishing</button>
  <button id="tab-profile" class="flex-1 py-2 rounded tab-inactive">Profile</button>
  <button id="tab-leaderboard" class="flex-1 py-2 rounded tab-inactive">Leaderboard</button>
</div>

<!-- FISHING SCREEN -->
<div id="screen-fishing">
  <button id="toggle-fishing-button"
          class="w-full py-2 bg-yellow-500 text-black font-bold rounded mb-4">
    Start Fishing
  </button>

  <div class="bg-gray-700 p-3 rounded text-center mb-4">
    <p id="current-status" class="text-green-400 font-bold">Stopped</p>
    <p id="time-to-bite" class="text-gray-300 text-sm">Waiting for a bite…</p>
  </div>

  <button id="reel-button"
          class="hidden w-full py-3 bg-green-500 text-black font-bold rounded mb-4">
    Reel In!
  </button>

  <div>
    <h2 class="font-bold mb-2 border-b border-blue-800">Last Catch</h2>
    <div id="log-content" class="bg-gray-800 rounded p-3 border-l-4 border-blue-500">
      No catches yet.
    </div>
  </div>
</div>

<!-- PROFILE SCREEN -->
<div id="screen-profile" class="hidden">
  <h2 class="text-xl font-bold mb-3">Your Stats</h2>
  <p>Biggest carp: <span id="stat-biggest-carp">0</span> kg</p>
  <p>Biggest common: <span id="stat-biggest-common">0</span> kg</p>
  <p>Biggest mirror: <span id="stat-biggest-mirror">0</span> kg</p>
  <p>Total weight: <span id="stat-total-weight">0</span> kg</p>
</div>

<!-- LEADERBOARD SCREEN -->
<div id="screen-leaderboard" class="hidden">
  <h2 class="text-xl font-bold mb-1">Leaderboard</h2>
  <div class="flex gap-2 mb-3">
    <button id="btn-leaderboard-biggest"
            class="flex-1 py-2 rounded text-sm font-bold bg-blue-600 text-white">
      Biggest Carp
    </button>
    <button id="btn-leaderboard-total"
            class="flex-1 py-2 rounded text-sm font-bold bg-gray-700 text-gray-200">
      Total Weight
    </button>
  </div>
  <div id="leaderboard-list" class="space-y-2 text-sm">
    <p class="text-gray-400 text-sm">Loading leaderboard…</p>
  </div>
</div>

</div>

<script type="module">
/* -----------------------------------
   FIREBASE INITIALIZATION
----------------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, query, orderBy, limit } 
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyASz_xXcEF5pV6CAZR9YfPMUxk_8kS_VTU",
  authDomain: "carp-simulator-app-394af.firebaseapp.com",
  projectId: "carp-simulator-app-394af",
  storageBucket: "carp-simulator-app-394af.firebasestorage.app",
  messagingSenderId: "761509507210",
  appId: "1:761509507210:web:1c5bb0d8af518fab3ebd73"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

/* -----------------------------------
   GLOBAL VARIABLES
----------------------------------- */
let uid = null;
let profile = null;
let isFishing = false;
let biteTimeout = null;
let catchTimer = null;
let countdown = 0;

/* -----------------------------------
   AUTH & PROFILE LOADING
----------------------------------- */
onAuthStateChanged(auth, async (user) => {
  if (!user) return;
  uid = user.uid;

  const ref = doc(db, "players", uid);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    // New user — wait for username
  } else {
    profile = snap.data();
    document.getElementById("header-username").textContent = profile.username;
    document.getElementById("startup-overlay").style.display = "none";
    loadStatsToUI();
  }
});

signInAnonymously(auth);

/* -----------------------------------
   SAVE PROFILE NAME
----------------------------------- */
document.getElementById("save-profile-btn").onclick = async () => {
  const name = document.getElementById("profile-name-input").value.trim();
  if (!name) return alert("Enter a username!");

  const ref = doc(db, "players", uid);

  profile = {
    username: name,
    biggestCarp: 0,
    biggestCommon: 0,
    biggestMirror: 0,
    totalWeight: 0
  };

  await setDoc(ref, profile);
  document.getElementById("startup-overlay").style.display = "none";
  document.getElementById("header-username").textContent = name;
};

/* -----------------------------------
   FISHING LOGIC
----------------------------------- */
function startFishing() {
  if (isFishing) return;
  isFishing = true;

  document.getElementById("toggle-fishing-button").textContent = "Stop Fishing";
  document.getElementById("current-status").textContent = "Waiting…";

  const min = 5000;
  const max = 60000;
  const bite = Math.floor(Math.random() * (max - min)) + min;

  biteTimeout = setTimeout(triggerBite, bite);
}

function stopFishing() {
  isFishing = false;
  clearTimeout(biteTimeout);
  clearInterval(catchTimer);

  document.getElementById("toggle-fishing-button").textContent = "Start Fishing";
  document.getElementById("current-status").textContent = "Stopped";
}

function triggerBite() {
  if (!isFishing) return;

  navigator.vibrate(800);
  document.getElementById("current-status").textContent = "FISH ON!";
  document.getElementById("reel-button").classList.remove("hidden");

  countdown = 12;
  catchTimer = setInterval(() => {
    countdown--;
    document.getElementById("reel-button").textContent = `Reel In! (${countdown}s)`;

    if (countdown <= 0) {
      clearInterval(catchTimer);
      document.getElementById("reel-button").classList.add("hidden");
      document.getElementById("current-status").textContent = "Lost the fish!";
      isFishing = false;
      document.getElementById("toggle-fishing-button").textContent = "Start Fishing";
    }
  }, 1000);
}

document.getElementById("toggle-fishing-button").onclick = () => {
  if (isFishing) stopFishing(); else startFishing();
};

/* -----------------------------------
   REEL IN — FIXED (NO AUTO START)
----------------------------------- */
document.getElementById("reel-button").onclick = async () => {
  clearInterval(catchTimer);

  document.getElementById("reel-button").classList.add("hidden");
  document.getElementById("current-status").textContent = "Fish landed!";
  navigator.vibrate(300);

  const fish = generateFish();
  displayCatch(fish);
  await updateStats(fish);

  isFishing = false;
  document.getElementById("toggle-fishing-button").textContent = "Start Fishing";
  document.getElementById("time-to-bite").textContent = "Press Start Fishing to cast again.";
};

/* -----------------------------------
   FISH GENERATOR
----------------------------------- */
function generateFish() {
  const species = ["Common", "Mirror", "Fully Scaled", "Ghost", "Koi", "Catfish"];
  const chosen = species[Math.floor(Math.random() * species.length)];

  let weight = Math.random() * 13 + 4; // 4–17kg mostly
  if (Math.random() < 0.18) weight += Math.random() * 20 + 17; // 17–37kg
  if (Math.random() < 0.03) weight += Math.random() * 15 + 37; // 37–52kg

  weight = Number(weight.toFixed(1));

  const lb = Number((weight * 2.20462).toFixed(1));
  return { species: chosen, weight, lb };
}

/* -----------------------------------
   DISPLAY CATCH
----------------------------------- */
function displayCatch(fish) {
  document.getElementById("log-content").innerHTML = `
    <p class="text-xl font-bold text-yellow-300">${fish.weight} kg (${fish.lb} lb)</p>
    <p>${fish.species}</p>
  `;
}

/* -----------------------------------
   UPDATE PLAYER STATS
----------------------------------- */
async function updateStats(fish) {
  const ref = doc(db, "players", uid);

  if (!profile) return;

  let pb = false;

  if (fish.weight > profile.biggestCarp) {
    profile.biggestCarp = fish.weight;
    pb = true;
  }
  if (fish.species === "Common" && fish.weight > profile.biggestCommon)
    profile.biggestCommon = fish.weight;
  if (fish.species === "Mirror" && fish.weight > profile.biggestMirror)
    profile.biggestMirror = fish.weight;

  profile.totalWeight += fish.weight;

  await updateDoc(ref, profile);
  loadStatsToUI();

  if (pb) showPBPopup(fish);
}

/* -----------------------------------
   LOAD STATS INTO PROFILE UI
----------------------------------- */
function loadStatsToUI() {
  document.getElementById("stat-biggest-carp").textContent = profile.biggestCarp;
  document.getElementById("stat-biggest-common").textContent = profile.biggestCommon;
  document.getElementById("stat-biggest-mirror").textContent = profile.biggestMirror;
  document.getElementById("stat-total-weight").textContent = profile.totalWeight;
}

/* -----------------------------------
   PB POPUP
----------------------------------- */
function showPBPopup(fish) {
  const popup = document.getElementById("pb-popup");
  const text = document.getElementById("pb-text");
  text.textContent = `NEW PB! ${fish.lb} lb ${fish.species}`;
  popup.classList.remove("hidden");

  setTimeout(() => popup.classList.add("hidden"), 2800);
}

/* -----------------------------------
   TABS
----------------------------------- */
function showScreen(fishing, profile, leaderboard) {
  document.getElementById("screen-fishing").classList.toggle("hidden", !fishing);
  document.getElementById("screen-profile").classList.toggle("hidden", !profile);
  document.getElementById("screen-leaderboard").classList.toggle("hidden", !leaderboard);
}

document.getElementById("tab-fishing").onclick = () => {
  showScreen(true, false, false);
  setTab("fishing");
};
document.getElementById("tab-profile").onclick = () => {
  showScreen(false, true, false);
  setTab("profile");
};
document.getElementById("tab-leaderboard").onclick = () => {
  showScreen(false, false, true);
  setTab("leaderboard");
  loadLeaderboardBiggest();
};

function setTab(tab) {
  document.getElementById("tab-fishing").className =
    tab === "fishing" ? "flex-1 py-2 rounded tab-active" : "flex-1 py-2 rounded tab-inactive";
  document.getElementById("tab-profile").className =
    tab === "profile" ? "flex-1 py-2 rounded tab-active" : "flex-1 py-2 rounded tab-inactive";
  document.getElementById("tab-leaderboard").className =
    tab === "leaderboard" ? "flex-1 py-2 rounded tab-active" : "flex-1 py-2 rounded tab-inactive";
}

/* -----------------------------------
   LEADERBOARD
----------------------------------- */
async function loadLeaderboardBiggest() {
  const q = query(collection(db, "players"), orderBy("biggestCarp", "desc"), limit(20));
  const snap = await getDocs(q);

  renderLeaderboard(snap, "biggestCarp");
}

async function loadLeaderboardTotal() {
  const q = query(collection(db, "players"), orderBy("totalWeight", "desc"), limit(20));
  const snap = await getDocs(q);

  renderLeaderboard(snap, "totalWeight");
}

function renderLeaderboard(snap, key) {
  let html = "";
  snap.forEach((doc) => {
    const d = doc.data();
    html += `<p><span class="font-bold">${d.username}</span> — ${d[key]} kg</p>`;
  });

  document.getElementById("leaderboard-list").innerHTML = html;
}

document.getElementById("btn-leaderboard-biggest").onclick = loadLeaderboardBiggest;
document.getElementById("btn-leaderboard-total").onclick = loadLeaderboardTotal;

</script>

</body>
</html>
