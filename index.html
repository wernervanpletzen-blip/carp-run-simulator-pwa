<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Carp Run Alarm Simulator</title>

  <!-- PWA Meta -->
  <meta name="theme-color" content="#111827" />
  <meta name="description" content="Simulate real carp fishing runs with authentic Delkim alarm sounds and random bite timing." />

  <!-- Manifest (correct path for GitHub Pages) -->
  <link rel="manifest" href="./manifest.webmanifest" />

  <!-- App Icons -->
  <link rel="apple-touch-icon" href="./assets/icon-192.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="./assets/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="./assets/icon-512.png" />

  <!-- Apple Compatibility -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Carp Run" />

  <!-- Tailwind + Fonts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet" />

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #000;
      margin: 0;
      padding: 0;
    }

    .alarm-flash {
      animation: flash 0.3s infinite alternate;
      background-color: #ff3333 !important;
      color: #fff !important;
    }

    @keyframes flash {
      from { box-shadow: 0 0 15px #ff3333; }
      to { box-shadow: 0 0 30px #ff0000; }
    }
  </style>
</head>

<body class="bg-black text-white flex justify-center items-center min-h-screen p-4">
  <div id="app-container" class="bg-gray-900 border-2 border-gray-700 rounded-xl p-6 w-full max-w-lg text-center">
    
    <img src="./assets/logo.png" alt="Carp Run Logo" class="mx-auto w-32 h-32 object-contain mb-6" />

    <button id="toggle-fishing-button"
      class="px-6 py-2 text-lg font-bold rounded-lg bg-yellow-500 text-gray-900 hover:bg-yellow-400 transition mb-6"
      onclick="toggleFishing()">Start Fishing</button>

    <div id="status-display" class="bg-gray-700 p-4 mb-6 rounded-lg">
      <p id="current-status" class="text-lg font-bold text-green-400">Stopped</p>
      <p id="time-to-bite" class="text-sm mt-1 text-gray-300">
        Ready to cast your lines! The wait could be anywhere from 5 seconds to 1 minute.
      </p>
    </div>

    <button id="reel-button"
      class="hidden w-full px-6 py-4 text-2xl font-bold rounded-xl bg-green-500 text-gray-900 hover:bg-green-400 transition mb-6"
      onclick="reelIn()">Reel In! (15s left)</button>

    <div id="last-catch-log" class="text-left">
      <h2 class="text-xl font-bold mb-2 uppercase border-b border-blue-800 pb-1">Last Catch Statistics</h2>
      <div id="log-content" class="bg-gray-800 rounded-lg p-4 border-l-4 border-blue-500">
        <p class="text-gray-300">No successful catches yet. Tight lines!</p>
      </div>
    </div>
  </div>

  <!-- Install App Button -->
  <button id="install-btn"
    class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 bg-blue-500 text-white font-bold px-5 py-3 rounded-lg shadow-lg hover:bg-blue-600 z-50">
    Install Carp Run App
  </button>

  <script type="module">
    /* ---------------------------
       SERVICE WORKER REGISTRATION
    ----------------------------*/
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => console.log('Service Worker registered:', reg.scope))
          .catch(err => console.log('Service Worker failed:', err));
      });
    }

    /* ---------------------------
       GLOBAL STATE
    ----------------------------*/
    let status = 'STOPPED';
    let isFishing = false;
    let catchTimer = null;
    let biteTimeout = null;
    let countdownValue = 0;

    /* ---------------------------
       WAKE LOCK
    ----------------------------*/
    let wakeLock = null;
    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
        } catch (err) { console.error(err); }
      }
    }
    async function releaseWakeLock() {
      if (wakeLock) {
        await wakeLock.release();
        wakeLock = null;
      }
    }

    /* ---------------------------
       AUDIO SETUP
    ----------------------------*/
    const alarmSound = new Audio('./assets/CarpRunSound001.mp3');
    alarmSound.loop = true;
    function startAlarmSound() { alarmSound.currentTime = 0; alarmSound.play().catch(()=>{}); }
    function stopAlarmSound() { alarmSound.pause(); alarmSound.currentTime = 0; }

    /* ---------------------------
       DOM ELEMENTS
    ----------------------------*/
    const statusEl = document.getElementById('current-status');
    const timeEl = document.getElementById('time-to-bite');
    const reelBtn = document.getElementById('reel-button');
    const logEl = document.getElementById('log-content');
    const toggleBtn = document.getElementById('toggle-fishing-button');
    const appContainer = document.getElementById('app-container');
    const installBtn = document.getElementById('install-btn');

    /* ---------------------------
       BITE TIME: 5s â€“ 60s
    ----------------------------*/
    function getNextBiteTime() {
      const minMs = 5000;   // 5 seconds
      const maxMs = 60000;  // 1 minute
      return Math.floor(Math.random() * (maxMs - minMs + 1)) + minMs;
    }

    /* ---------------------------
       STATUS UPDATE
    ----------------------------*/
    function updateStatus(newStatus, msg) {
      status = newStatus;
      statusEl.textContent = `STATUS: ${newStatus}`;
      appContainer.classList.remove('alarm-flash');
      reelBtn.classList.add('hidden');

      if (newStatus !== 'ALARM') timeEl.textContent = msg;

      if (newStatus === 'ALARM') {
        appContainer.classList.add('alarm-flash');
        reelBtn.classList.remove('hidden');
        reelBtn.textContent = `Reel In! (${countdownValue}s left)`;
      }
    }

    /* ---------------------------
       FISHING CONTROL
    ----------------------------*/
    function startFishingCycle() {
      requestWakeLock();
      isFishing = true;
      toggleBtn.textContent = "Stop Fishing";
      toggleBtn.classList.replace('bg-yellow-500', 'bg-red-600');

      clearTimeout(biteTimeout);
      biteTimeout = setTimeout(startBite, getNextBiteTime());

      updateStatus('FISHING', 'Bait set. Waiting for the sound of a big run...');
    }

    function stopFishing() {
      releaseWakeLock();
      isFishing = false;
      toggleBtn.textContent = "Start Fishing";
      toggleBtn.classList.replace('bg-red-600', 'bg-yellow-500');

      clearTimeout(biteTimeout);
      clearInterval(catchTimer);

      stopAlarmSound();
      updateStatus('STOPPED', 'Fishing stopped. Press Start Fishing to cast again.');
    }

    window.toggleFishing = () => isFishing ? stopFishing() : startFishingCycle();

    /* ---------------------------
       BITE EVENT
    ----------------------------*/
    function startBite() {
      if (!isFishing) return;

      countdownValue = 15;
      updateStatus('ALARM', '*** FISH ON! REEL IN QUICK! ***');
      startAlarmSound();

      catchTimer = setInterval(() => {
        countdownValue--;
        reelBtn.textContent = `REEL IN! (${countdownValue}S LEFT)`;

        if (countdownValue <= 0) {
          clearInterval(catchTimer);
          stopAlarmSound();
          updateStatus('LOST', 'âŒ TOO SLOW! The fish got away!');
          if (isFishing) setTimeout(startFishingCycle, 5000);
        }
      }, 1000);
    }

    /* ---------------------------
       REEL IN SUCCESS
    ----------------------------*/
    window.reelIn = () => {
      if (status !== 'ALARM') return;
      clearInterval(catchTimer);
      stopAlarmSound();

      updateStatus('CAUGHT', 'ðŸŽ‰ REELING SUCCESSFUL!');

      const fish = generateCatch();
      displayCatch(fish);

      if (isFishing) setTimeout(startFishingCycle, 5000);
    };

    function generateCatch() {
      const species = ['Common Carp', 'Mirror Carp', 'Ghost Carp', 'Leather Carp', 'Fully Scaled Carp'];
      const type = species[Math.floor(Math.random() * species.length)];

      let w = Math.random() < 0.5 ? Math.random() * 20 + 15 :
               Math.random() < 0.85 ? Math.random() * 15 + 35 :
                                      Math.random() * 20 + 50;

      return {
        species: type,
        weight: w.toFixed(1),
        time: new Date().toLocaleString()
      };
    }

    function displayCatch(f) {
      logEl.innerHTML = `
        <div class="space-y-2">
          <p class="font-extrabold text-2xl text-yellow-400">${f.weight} LBS</p>
          <p class="font-bold text-lg">${f.species.toUpperCase()}</p>
          <p class="text-sm text-gray-400">Time: ${f.time}</p>
          <p class="text-xs text-gray-500 mt-2">Ready to cast again in 5 seconds...</p>
        </div>`;
    }

    /* ---------------------------
       INSTALL BUTTON
    ----------------------------*/
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.classList.remove('hidden');
    });

    installBtn.addEventListener('click', () => {
      installBtn.classList.add('hidden');
      deferredPrompt.prompt();
      deferredPrompt = null;
    });

    /* ---------------------------
       INITIAL LOAD
    ----------------------------*/
    window.onload = () => {
      updateStatus('STOPPED', 'Ready to cast your lines! The wait could be anywhere from 5 seconds to 1 minute.');
    };
  </script>
</body>
</html>
