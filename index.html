<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carp Run Alarm Simulator</title>

  <!-- PWA Metadata -->
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background-color: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    #app-container {
      background-color: #111827;
      color: #fff;
      max-width: 600px;
      width: 100%;
      border-radius: 1rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
      border: 2px solid #374151;
      padding: 30px;
      transition: all 0.2s ease-in-out;
      position: relative;
    }

    .alarm-flash {
      animation: flash 0.3s infinite alternate;
      background-color: #ff3333 !important;
      color: #fff !important;
    }

    @keyframes flash {
      from { box-shadow: 0 0 15px #ff3333, 0 0 5px #ff3333; }
      to { box-shadow: 0 0 30px #ff0000, 0 0 10px #ff0000; }
    }

    #install-btn {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #3b82f6;
      color: white;
      font-weight: bold;
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      z-index: 9999;
      transition: background-color 0.3s ease;
    }

    #install-btn:hover {
      background-color: #2563eb;
    }
  </style>
</head>

<body>
  <div id="app-container" class="rounded-xl">
    <div class="text-center mb-6">
      <img src="./assets/logo.png" alt="Carp Run Logo" class="mx-auto w-32 h-32 object-contain" />
    </div>

    <div class="flex justify-center mb-6">
      <button id="toggle-fishing-button"
        class="px-6 py-2 text-lg font-bold rounded-lg bg-yellow-500 text-gray-900 hover:bg-yellow-400 transition"
        onclick="toggleFishing()">Start Fishing</button>
    </div>

    <div id="status-display" class="p-4 mb-6 text-center rounded-lg bg-gray-700">
      <p id="current-status" class="text-lg font-bold text-green-400">Stopped</p>
      <p id="time-to-bite" class="text-sm mt-1 text-gray-400">
        Ready to cast your lines! The wait could be anywhere from 2 to 30 minutes.
      </p>
    </div>

    <div class="flex flex-col items-center space-y-4">
      <button id="reel-button"
        class="w-full px-6 py-4 text-2xl font-bold rounded-xl bg-green-500 text-gray-900 hover:bg-green-400 transition hidden"
        onclick="reelIn()">Reel In! (15s left)</button>

      <div id="last-catch-log" class="w-full mt-6 text-sm">
        <h2 class="text-xl font-bold mb-2 text-white uppercase border-b border-blue-800 pb-1">
          Last Catch Statistics
        </h2>
        <div id="log-content" class="bg-gray-800 rounded-lg p-4 border-l-4 border-blue-500">
          <p class="text-gray-300">No successful catches yet. Tight lines!</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Install App Button -->
  <button id="install-btn">Install Carp Run App</button>

  <script type="module">
    // --- PWA Service Worker Registration ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(reg => console.log('ServiceWorker registered:', reg.scope))
          .catch(err => console.log('ServiceWorker failed:', err));
      });
    }

    // --- Global State ---
    let status = 'STOPPED';
    let isFishing = false;
    let catchTimer = null;
    let biteTimeout = null;
    let countdownValue = 0;

    // --- Screen Wake Lock (keeps screen awake) ---
    let wakeLock = null;
    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          console.log('Wake Lock active');
          wakeLock.addEventListener('release', () => console.log('Wake Lock released'));
        } catch (err) {
          console.error('Wake Lock error:', err);
        }
      }
    }

    async function releaseWakeLock() {
      if (wakeLock) {
        await wakeLock.release();
        wakeLock = null;
      }
    }

    // --- Audio Setup ---
    const alarmSound = new Audio('./assets/CarpRunSound001.mp3');
    alarmSound.loop = true;

    function startAlarmSound() {
      alarmSound.currentTime = 0;
      alarmSound.play().catch(err => console.warn("Autoplay prevented:", err));
    }

    function stopAlarmSound() {
      alarmSound.pause();
      alarmSound.currentTime = 0;
    }

    // --- DOM Elements ---
    const currentStatusEl = document.getElementById('current-status');
    const timeToBiteEl = document.getElementById('time-to-bite');
    const reelButton = document.getElementById('reel-button');
    const logContentEl = document.getElementById('log-content');
    const toggleFishingButton = document.getElementById('toggle-fishing-button');
    const appContainer = document.getElementById('app-container');
    const installBtn = document.getElementById('install-btn');

    // --- Fishing Simulation ---
    function getNextBiteTime() {
      const minMs = 120000;   // 2 min
      const maxMs = 1800000;  // 30 min
      return Math.floor(Math.random() * (maxMs - minMs + 1)) + minMs;
    }

    function updateStatus(newStatus, message) {
      status = newStatus;
      currentStatusEl.textContent = `STATUS: ${newStatus}`;
      appContainer.classList.remove('alarm-flash');
      reelButton.classList.add('hidden');
      if (status !== 'ALARM') timeToBiteEl.textContent = message;

      if (status === 'ALARM') {
        appContainer.classList.add('alarm-flash');
        reelButton.classList.remove('hidden');
        reelButton.textContent = `Reel In! (${countdownValue}s left)`;
      }
    }

    function startFishingCycle() {
      requestWakeLock();
      isFishing = true;
      toggleFishingButton.textContent = "Stop Fishing";
      toggleFishingButton.classList.replace('bg-yellow-500', 'bg-red-600');

      if (biteTimeout) clearTimeout(biteTimeout);
      const nextBiteMs = getNextBiteTime();
      biteTimeout = setTimeout(startBite, nextBiteMs);

      updateStatus('FISHING', 'Bait set. Waiting for the sound of a big run...');
    }

    function stopFishing() {
      releaseWakeLock();
      isFishing = false;
      toggleFishingButton.textContent = "Start Fishing";
      toggleFishingButton.classList.replace('bg-red-600', 'bg-yellow-500');

      clearTimeout(biteTimeout);
      clearInterval(catchTimer);

      stopAlarmSound();
      updateStatus('STOPPED', 'Fishing stopped. Press Start Fishing to cast again.');
    }

    window.toggleFishing = () => isFishing ? stopFishing() : startFishingCycle();

    function startBite() {
      if (!isFishing) return;
      console.log("ðŸŽ£ Fish on!");
      countdownValue = 15;
      updateStatus('ALARM', '*** FISH ON! REEL IN QUICK! ***');
      startAlarmSound();

      catchTimer = setInterval(() => {
        countdownValue--;
        reelButton.textContent = `REEL IN! (${countdownValue}S LEFT)`;

        if (countdownValue <= 0) {
          clearInterval(catchTimer);
          stopAlarmSound();
          updateStatus('LOST', 'âŒ TOO SLOW! The line snapped and the fish got away!');
          if (isFishing) setTimeout(startFishingCycle, 5000);
        }
      }, 1000);
    }

    window.reelIn = function () {
      if (status !== 'ALARM') return;
      clearInterval(catchTimer);
      stopAlarmSound();
      updateStatus('CAUGHT', 'ðŸŽ‰ REELING SUCCESSFUL!');
      displayCarpStats(generateCarpDetails());
      if (isFishing) setTimeout(startFishingCycle, 5000);
    };

    function generateCarpDetails() {
      const species = ['Common Carp', 'Mirror Carp', 'Ghost Carp', 'Leather Carp', 'Fully Scaled Carp'];
      const s = species[Math.floor(Math.random() * species.length)];
      let w = Math.random() < 0.5 ? Math.random() * 20 + 15 :
               Math.random() < 0.85 ? Math.random() * 15 + 35 :
               Math.random() * 20 + 50;
      return { species: s, weight: w.toFixed(1), timestamp: new Date().toLocaleString() };
    }

    function displayCarpStats(c) {
      logContentEl.innerHTML = `
        <div class="space-y-2 text-white">
          <p class="font-extrabold text-2xl text-yellow-400">${c.weight} LBS</p>
          <p class="font-bold text-lg">${c.species.toUpperCase()}</p>
          <p class="text-sm text-gray-400">Time: ${c.timestamp}</p>
          <p class="text-xs text-gray-500 mt-2">Ready to cast again in 5 seconds...</p>
        </div>`;
    }

    // --- Install Prompt ---
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'block';
    });

    installBtn.addEventListener('click', () => {
      installBtn.style.display = 'none';
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(() => deferredPrompt = null);
    });

    window.onload = () => updateStatus('STOPPED', 'Ready to cast your lines! The wait could be anywhere from 2 to 30 minutes.');
  </script>
</body>
</html>
